#!/bin/bash

set -e
COMMIT=$1
ARCH=$2

if which gmake >/dev/null 2>&1
then
    MAKE=gmake
else
    MAKE=make
fi

cat >EXCLUDE <<EOT
pax_global_header
known-good
tests
EOT

git archive --prefix=tmp-$$/ --remote=.. $COMMIT | tar xf - -X EXCLUDE
cd tmp-$$
ln -s .. known-good
echo "method gitrevision() { \"$COMMIT\" }" > buildinfo.gc
cp buildinfo.gc buildinfo.grace
$MAKE l2/minigrace
cd ..

mkdir -p "$ARCH"
mv tmp-$$/l2/minigrace $ARCH/minigrace-$COMMIT
cp tmp-$$/l2/gracelib.o $ARCH/gracelib-$COMMIT.o
cp tmp-$$/l2/gracelib.h $ARCH/gracelib-$COMMIT.h
for x in tmp-$$/l2/*.c
do
   nm=$(basename "$x")
   nm=$(cut -d. -f1 <<<"$nm")
   mv $x independent/$nm-$COMMIT.c
done

rm -rf tmp-$$ EXCLUDE
