#!/bin/bash

DISTRIB=tree
PLATFORM=$(uname)
PREFIX=.
LDFLAGS=
UNICODE_LDFLAGS=

ADVISE_END=
advise() {
    why=$1
    ADVISE_END=$why
    echo
    echo "Problem configuring $why."
    if [ -e "environ-$PLATFORM" ]
    then
        echo
        echo Running the environ-$PLATFORM script may help to diagnose or
        echo solve this problem.
        echo
        if ! [ "$IN_ENVIRON_SCRIPT" ]
        then
            echo Re-running configure inside environ-$PLATFORM.
            echo
            if ./environ-$PLATFORM ./configure
            then
                echo
                echo As configure succeeded, launching a suitable environment
                echo in which to run other programs. To obtain this environment
                echo in future, run ./environ-$PLATFORM.
                echo
                exec ./environ-$PLATFORM
            fi
            exit $?
        fi
    fi
}
fail() {
    advise "$@"
    echo Failed.
    exit 1
}

while [ $# -gt 0 ]
do
    if [ "$1" = "--prefix" ]
    then
        PREFIX=$2
        shift
    elif [ "$1" = "--static" ]
    then
        STATIC=y
    elif [ "$1" = "--help" ]
    then
        echo "Available flags:"
        echo " --prefix <path>"
        echo " --static {tarball only}"
        exit 0
    else
        echo "Unknown argument '$1'."
        exit 1
    fi
    shift
done

UNICODE_MODULE=unicode.gso
if grep -qi CYGWIN <<<"$PLATFORM"
then
    if [ "$distrib" = "tree" ]
    then
        echo "Building on Cygwin is currently only supported from tarballs."
        echo "Tarballs available from http://ecs.vuw.ac.nz/~mwh/minigrace/dist/"
        exit 1
    fi
    STATIC=y
fi

if [ "$STATIC" ]
then
    UNICODE_MODULE=unicode.gcn
    STATIC_MODULES=unicode.gcn
    if [ -e minigrace.c ]
    then
        echo "Patching minigrace.c for static build..."
        sed -i 's/dlmodule("unicode")/module_unicode_init()/' minigrace.c
    fi
fi

echo -n "Locating linker... "
LD_PATH=$(which ld 2>/dev/null)
if [ "$LD_PATH" ]
then
    echo $LD_PATH
else
    echo "none."
    fail "linker"
fi

echo -n "Checking linker... "
case "$(ld -v 2>&1)" in
    "GNU ld"*)
    GNU_LD=1
    echo GNU LD.
    LDFLAGS="-Wl,--export-dynamic"
    ;;
    *PROJECT:ld*)
    LLVM_LD=1
    echo LLVM LD.
    UNICODE_LDFLAGS="-Wl,-undefined -Wl,dynamic_lookup"
    ;;
    *llvm*)
    LLVM_LD=1
    echo LLVM LD.
    UNICODE_LDFLAGS="-Wl,-undefined -Wl,dynamic_lookup"
    ;;
    *)
    echo unknown.
    ;;
esac

echo -n "Checking for -ldl... "
if ld -o /dev/null -ldl >/dev/null 2>&1
then
    echo yes.
    LDFLAGS="$LDFLAGS -ldl"
    if [ "$DISTRIB" = tree ]
    then
        echo -n "Checking for default -Wl,--as-needed... "
        cat <<EOT >configure-$$.c
#include <dlfcn.h>

int main() {
    dlopen(0, 0);
    return 0;
}
EOT
        if ! gcc -o configure-$$.x -ldl configure-$$.c >/dev/null 2>&1
        then
            echo "yes."
            echo "Your system defaults to using -Wl,--as-needed. These systems"
            echo "are currently only supported from tarball builds."
            echo "Tarballs are available from:"
            echo "    http://ecs.vuw.ac.nz/~mwh/minigrace/dist/"
            rm -f configure-$$.*
            exit 1
        else
            echo "no."
        fi
        rm -f configure-$$.*
    fi
else
    echo no.
fi

echo -n "Locating GNU make... "
GMAKE_PATH=$(which gmake 2>/dev/null)
if [ "$GMAKE_PATH" ]
then
    echo $GMAKE_PATH
else
    GMAKE_PATH=$(which make 2>/dev/null)
    if [ "$GMAKE_PATH" ]
    then
        echo $GMAKE_PATH
    else
        echo "none."
        advise "GNU make"
    fi
fi

MK=make
if gmake -v 2>&1 | grep -q GNU
then
    MK=gmake
elif make -v 2>&1 | grep -q GNU
then
    MK=make
else
    echo "This software requires GNU make to build."
    echo "Substitute the path to your GNU make below."
fi

echo -n "Locating gcc... "
GCC_PATH=$(which gcc 2>/dev/null)
if [ "$GCC_PATH" ]
then
    echo $GCC_PATH
else
    echo "none."
    fail "gcc"
fi

echo -n "Checking GCC search paths... "
cat <<EOT >> tmp-$$.c
#include <setjmp.h>
int main() {
    return 0;
}
EOT
if ! gcc -o tmp-$$ tmp-$$.c
then
    fail "gcc"
else
    echo "OK."
fi
rm -f tmp-$${.c,}

if [ "$DISTRIB" = "tarball" ]
then
    echo "Run '$MK' to build, and '$MK selfhost' to have it compile itself."
else
    echo "Run '$MK' to build."
fi

cat <<EOT > Makefile.conf
PREFIX = $PREFIX
LDFLAGS = $LDFLAGS -lm
UNICODE_LDFLAGS = $UNICODE_LDFLAGS
UNICODE_MODULE = $UNICODE_MODULE
STATIC_MODULES = $STATIC_MODULES
EOT

if [ "$ADVISE_END" ]
then
    echo configure encountered a non-fatal configuration problem.
    advise "$ADVISE_END"
    echo
    echo This issue did not cause configure to fail, but you may wish to
    echo investigate it.
fi
