<!DOCTYPE html>
<html>
 <head>
     <title>Minigrace JavaScript backend</title>
     <script type="text/javascript">
         var goldenOutput = "";
         var goldenOutputOffset = 0;
         var compileError = false;
         var passes = 0;
         function compile() {
            importedModules = {};
            stdout_txt = document.getElementById("js_txt");
            stdin_txt = document.getElementById("code_txt");
            stderr_txt = document.getElementById("stderr_txt");
            stderr_txt.value = "";
            stdout_txt.value = "";
            compileError = false;
            try {
                gracecode_compiler.call({methods:{}, data: {}});
            } catch (e) {
                if (e == "ErrorExit") {
                    compileError = true;
                } else if (e == "SystemExit") {
                    // pass
                } else {
                    throw e;
                }
            }
         }
        function run() {
            importedModules = {};
            stdout_txt = document.getElementById("stdout_txt");
            stdin_txt = document.getElementById("stdout_txt");
            stderr_txt = document.getElementById("stderr_txt");
            var code = document.getElementById("js_txt").value;
            lineNumber = 1;
            eval(code);
            testpass = false;
            try {
                gracecode_USER.call({methods:{}, data: {}, className: "__main__"});
            } catch (e) {
                if (e != "SystemExit") {
                    stderr_txt.value += "Runtime error around line " + lineNumber + "\n";
                    throw e;
                }
            }
            if (goldenOutput != "") {
                var realOut = stdout_txt.value.substr(goldenOutputOffset);
                if (realOut == goldenOutput) {
                    stderr_txt.value += "\nTest passed.\n";
                    passes = passes + 1;
                } else {
                    stderr_txt.value += "\nTest failed.\n";
                }
                goldenOutput = "";
                setTimeout("stdout_txt.style.background = ''", 2500);
            }
        }
        function compilerun() {
            compile();
            if (!compileError) {
                run();
            }
        }
        function loadtest(testname) {
            var req = new XMLHttpRequest();
            req.open("GET", "./tests/" + testname + ".test.grace", false);
            req.send(null);
            if (req.status == 200) {
                document.getElementById("code_txt").value = req.responseText;
            }
            if (testname.indexOf(".fail") == -1) {
                req.open("GET", "./tests/" + testname + ".out", false);
                req.send(null);
                if (req.status == 200) {
                    document.getElementById("stdout_txt").value = "Golden output:\n" + req.responseText + "=================================\n";
                    goldenOutput = req.responseText;
                    goldenOutputOffset = document.getElementById("stdout_txt").value.length;
                }
            } else {
                document.getElementById("stdout_txt").value = "Expected result: syntax error.\n=================================\n";
            }
        }
        function modeswitch() {
            var show_llvm = document.getElementById("show_llvm");
            var show_ast = document.getElementById("show_ast");
            var show_tokens = document.getElementById("show_tokens");
            var show_types = document.getElementById("show_types");
            var run_but = document.getElementById("run_but");
            var compilerun_but = document.getElementById("compilerun_but");
            if (show_llvm.checked || show_ast.checked || show_tokens.checked
                    || show_types.checked) {
                run_but.disabled = true;
                compilerun_but.disabled = true;
            } else {
                run_but.disabled = false;
                compilerun_but.disabled = false;
            }
        }
        function testall() {
            var tc = document.getElementById('testcases');
            passes = 0;
            var tests = 0;
            var failures = [];
            for (var i=0;i<tc.children.length;i++) {
                tests++;
                tc.selectedIndex = i;
                loadtest(tc.children[i].value);
                var op = passes;
                compilerun();
                if (tc.children[i].value.indexOf(".fail") != -1) {
                    if (stderr_txt.value.indexOf("error") != -1) {
                        passes++;
                    } else {
                        failures.push(tc.children[i].value);
                    }
                } else {
                    if (op == passes)
                        failures.push(tc.children[i].value);
                }
            }
            stderr_txt.value += "\n\nRan all tests. Passed: "+passes+"/"+tests;
            if (failures.length > 0) {
                stderr_txt.value += "\nFailures: ";
                for (var i=0; i<failures.length; i++)
                    stderr_txt.value += "\n  " + failures[i];
            }
        }
     </script>
 </head>
 <textarea id="code_txt" rows="20" cols="60">print("Hello, world!")</textarea>
 <textarea id="js_txt" rows="20" cols="60"></textarea><br />
 <textarea id="stdout_txt" rows="20" cols="60"></textarea>
 <textarea id="stderr_txt" rows="20" cols="60"></textarea>
 <br />
 <input type="button" value="Compile" onclick="compile()" />
 <input type="button" id="run_but" value="Run code" onclick="run()" />
 <input type="button" id="compilerun_but" value="Compile & run" onclick="compilerun()" />
 <input type="checkbox" id="show_tokens" onchange="modeswitch()"/>Tokens
 <input type="checkbox" id="show_ast" onchange="modeswitch()" />Parse tree
 <input type="checkbox" id="show_llvm" onchange="modeswitch()" />LLVM
 <input type="checkbox" id="show_types" onchange="modeswitch()" />Types
 <input type="button" value="Load test case:" onclick="loadtest(document.getElementById('testcases').value)" />
 <select id="testcases">
<!--[!SH[ls tests | grep .test.grace | grep -v unicode | grep -v controlchar | while read fn ; do if echo "$fn" | grep -q fail ; then o=$(echo "$fn"|cut -d. -f1-2) ; else o=$(echo "$fn"|cut -d. -f1) ; fi ; echo "  <option value=\"$o\">$o</option>" ; done]!]-->
 </select>
<span style="font-size: smaller;">
minigrace-js
<!--[!SH[echo "v0.0.2.$(tools/git-calculate-generation HEAD)"]!]-->
/
 <!--[!SH[git rev-parse HEAD|cut -b1-7]!]-->
</span>
 <br />
 <script src="gracelib.js" type="text/javascript"></script>
 <script src="compiler.js"></script>
 <script src="lexer.js"></script>
 <script src="ast.js"></script>
 <script src="parser.js"></script>
 <script src="genllvm.js"></script>
 <script src="genjs.js"></script>
 <script src="buildinfo.js"></script>
 <script src="subtype.js"></script>
</html>
